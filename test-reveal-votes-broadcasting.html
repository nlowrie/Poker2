<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reveal Votes Broadcasting Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
        }
        .test-section h3 {
            margin-top: 0;
            color: #007bff;
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }
        .step-number {
            font-weight: bold;
            color: #007bff;
            margin-right: 10px;
        }
        .code-block {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 12px;
            overflow-x: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .status-box {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Reveal Votes Broadcasting Test</h1>
        <p>This page helps you test the reveal votes broadcasting functionality in your planning poker application.</p>
        
        <div class="test-section">
            <h3>üìã Test Prerequisites</h3>
            <div class="status-box" id="prerequisites-status">
                <p><strong>Before running this test, make sure:</strong></p>
                <ul>
                    <li>‚úÖ You have the planning poker application running</li>
                    <li>‚úÖ You are logged in as a <strong>Moderator</strong></li>
                    <li>‚úÖ You have created a planning session</li>
                    <li>‚úÖ Team members have submitted votes for an item</li>
                    <li>‚úÖ The votes are currently <strong>hidden</strong> (not yet revealed)</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <h3>üîß Test Instructions</h3>
            
            <div class="step">
                <span class="step-number">Step 1:</span>
                <strong>Open your planning poker application in this browser tab/window</strong>
                <p>Navigate to your voting session where you can see the "Reveal Votes" button.</p>
            </div>
            
            <div class="step">
                <span class="step-number">Step 2:</span>
                <strong>Open Developer Console</strong>
                <p>Press <code>F12</code> or right-click ‚Üí "Inspect" ‚Üí "Console" tab</p>
            </div>
            
            <div class="step">
                <span class="step-number">Step 3:</span>
                <strong>Run the Test Script</strong>
                <p>Copy and paste this script into the console:</p>
                <div class="code-block" id="test-script">
// Reveal Votes Broadcasting Test Script
console.log('üß™ Testing Reveal Votes Broadcasting...');

// Test 1: Check if reveal button exists
const revealButton = document.querySelector('button:has(svg + text):contains("Reveal Votes")') || 
                    document.querySelector('button[class*="bg-blue-600"]:has(.lucide-eye)') ||
                    Array.from(document.querySelectorAll('button')).find(btn => btn.textContent.includes('Reveal Votes'));

if (revealButton) {
    console.log('‚úÖ Reveal Votes button found:', revealButton);
    console.log('Button text:', revealButton.textContent);
    console.log('Button classes:', revealButton.className);
    console.log('Button disabled:', revealButton.disabled);
} else {
    console.log('‚ùå Reveal Votes button not found');
    console.log('üí° Make sure you are a moderator with unrevealed votes');
}

// Test 2: Check vote elements
const voteElements = document.querySelectorAll('[class*="vote"], [data-testid*="vote"], .bg-gray-100');
console.log('üìä Found vote elements:', voteElements.length);

voteElements.forEach((el, i) => {
    console.log(`Vote ${i+1}:`, {
        text: el.textContent?.slice(0, 30) + '...',
        hidden: el.textContent?.includes('‚Ä¢') || el.textContent?.includes('?')
    });
});

// Test 3: Check for broadcast channel
if (typeof supabase !== 'undefined') {
    console.log('‚úÖ Supabase available for broadcasting');
} else {
    console.log('‚ö†Ô∏è Supabase not accessible from console');
}

console.log('üéØ Next: Click the "Reveal Votes" button and watch for broadcasts!');
                </div>
                <button onclick="copyTestScript()">üìã Copy Script</button>
            </div>
            
            <div class="step">
                <span class="step-number">Step 4:</span>
                <strong>Click "Reveal Votes" Button</strong>
                <p>In your application, click the blue "Reveal Votes" button and observe:</p>
                <ul>
                    <li>Console should show broadcast logs</li>
                    <li>Votes should become visible immediately</li>
                    <li>Timer should stop (if running)</li>
                    <li>Notification should appear</li>
                </ul>
            </div>
            
            <div class="step">
                <span class="step-number">Step 5:</span>
                <strong>Test Multi-User Broadcasting</strong>
                <p>To test that other participants receive the broadcast:</p>
                <ul>
                    <li>Open another browser window/tab (or use incognito mode)</li>
                    <li>Login as a different user (Team Member)</li>
                    <li>Join the same session</li>
                    <li>Go back to the moderator window and click "Reveal Votes"</li>
                    <li>Check if the team member window also shows revealed votes</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <h3>üîç Expected Results</h3>
            <div class="status-box">
                <h4 class="success">‚úÖ Success Indicators:</h4>
                <ul>
                    <li>Console shows "üì° BROADCASTING REVEAL VOTES" log</li>
                    <li>Console shows "‚úÖ Reveal votes broadcast sent successfully"</li>
                    <li>Votes become visible on moderator screen</li>
                    <li>Other participants see votes revealed simultaneously</li>
                    <li>Notifications appear: "Votes revealed to all participants!"</li>
                    <li>Timer stops if it was running</li>
                    <li>Estimation results/consensus are displayed</li>
                </ul>
                
                <h4 class="error">‚ùå Failure Indicators:</h4>
                <ul>
                    <li>Console shows "‚ùå Failed to broadcast reveal votes"</li>
                    <li>Console shows "‚ö†Ô∏è Cannot broadcast reveal votes"</li>
                    <li>Votes only revealed for moderator, not for other participants</li>
                    <li>No notifications appear</li>
                    <li>JavaScript errors in console</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <h3>üõ†Ô∏è Troubleshooting</h3>
            <div class="status-box">
                <h4>Common Issues:</h4>
                <ul>
                    <li><strong>Button not found:</strong> Make sure you're logged in as a Moderator with unrevealed votes</li>
                    <li><strong>No broadcast logs:</strong> Check network connectivity and Supabase connection</li>
                    <li><strong>Votes not revealing for others:</strong> Verify real-time channel subscription</li>
                    <li><strong>Console errors:</strong> Check for JavaScript errors and fix them first</li>
                </ul>
                
                <h4>Debug Commands:</h4>
                <div class="code-block">
// Check current user role
console.log('Current user role:', document.querySelector('[data-role]')?.dataset.role);

// Check channel status
console.log('Channel subscribed:', document.querySelector('[data-channel-status]')?.dataset.channelStatus);

// Check vote count
console.log('Vote count:', document.querySelectorAll('[class*="vote"]').length);

// Force refresh votes
if (typeof loadVotesForCurrentItem === 'function') {
    loadVotesForCurrentItem();
}
                </div>
                <button onclick="copyDebugScript()">üìã Copy Debug Commands</button>
            </div>
        </div>
    </div>

    <script>
        function copyTestScript() {
            const script = document.getElementById('test-script').textContent;
            navigator.clipboard.writeText(script).then(() => {
                alert('‚úÖ Test script copied to clipboard! Paste it in the browser console.');
            });
        }
        
        function copyDebugScript() {
            const debugScript = `
// Check current user role
console.log('Current user role:', document.querySelector('[data-role]')?.dataset.role);

// Check channel status  
console.log('Channel subscribed:', document.querySelector('[data-channel-status]')?.dataset.channelStatus);

// Check vote count
console.log('Vote count:', document.querySelectorAll('[class*="vote"]').length);

// Force refresh votes
if (typeof loadVotesForCurrentItem === 'function') {
    loadVotesForCurrentItem();
}
            `;
            navigator.clipboard.writeText(debugScript).then(() => {
                alert('‚úÖ Debug commands copied to clipboard!');
            });
        }
    </script>
</body>
</html>
